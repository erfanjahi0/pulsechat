<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PulseChat — Sign In</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect width='32' height='32' rx='8' fill='%236478ff'/><path d='M7 11h18M7 16h12M7 21h8' stroke='white' stroke-width='2.5' stroke-linecap='round'/></svg>" />
  <link rel="stylesheet" href="assets/css/base.css" />
  <link rel="stylesheet" href="assets/css/auth.css" />
  <script>
    (function() {
      const t = localStorage.getItem('pulsechat_theme');
      if (t) document.documentElement.setAttribute('data-theme', t);
      else if (!window.matchMedia('(prefers-color-scheme: dark)').matches)
        document.documentElement.setAttribute('data-theme', 'light');
    })();
  </script>
</head>
<body>
<div id="toast-container"></div>

<main class="auth-page">

  <!-- Left hero -->
  <section class="auth-hero" aria-label="PulseChat introduction">
    <div class="hero-grid-auth" aria-hidden="true"></div>

    <div class="hero-logo-auth">
      <div class="hero-logo-mark" aria-hidden="true">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
        </svg>
      </div>
      PulseChat
    </div>

    <div class="hero-body-auth">
      <h1 class="hero-tagline">
        Conversations<br/>that feel <em>alive</em>.
      </h1>
      <p class="hero-desc">
        Realtime 1-to-1 messaging with a clean, modern feel. Find people by @username or email.
      </p>
    </div>

    <ul class="hero-features-list" aria-label="Features">
      <li class="hero-feature-item">Unique @usernames for easy discovery</li>
      <li class="hero-feature-item">Realtime delivery with Firestore</li>
      <li class="hero-feature-item">Block users for privacy control</li>
      <li class="hero-feature-item">Beautiful dark &amp; light themes</li>
    </ul>
  </section>

  <!-- Right auth panel -->
  <section class="auth-panel">
    <!-- Mobile logo -->
    <div class="mobile-logo">
      <div class="mobile-logo-mark" aria-hidden="true">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
        </svg>
      </div>
      PulseChat
    </div>

    <div class="auth-card">
      <div class="auth-card-header">
        <h2 class="auth-card-title" id="auth-title">Welcome back</h2>
        <p class="auth-card-sub" id="auth-sub">Sign in to continue your conversations</p>
      </div>

      <div class="auth-tabs" role="tablist" aria-label="Sign in or create account">
        <button class="auth-tab active" role="tab" aria-selected="true" id="tab-login"
                aria-controls="panel-login" data-tab="login">Sign in</button>
        <button class="auth-tab" role="tab" aria-selected="false" id="tab-register"
                aria-controls="panel-register" data-tab="register">Create account</button>
      </div>

      <!-- Login -->
      <div class="auth-form-panel active" id="panel-login" role="tabpanel" aria-labelledby="tab-login">
        <form id="login-form" novalidate>
          <div class="auth-form-panel active" style="gap:var(--sp-md);">
            <div class="form-group">
              <label class="form-label" for="login-email">Email</label>
              <input class="form-input" type="email" id="login-email" name="email"
                     autocomplete="email" placeholder="you@example.com" required />
            </div>
            <div class="form-group">
              <label class="form-label" for="login-password">Password</label>
              <input class="form-input" type="password" id="login-password" name="password"
                     autocomplete="current-password" placeholder="••••••••" required />
            </div>
            <div id="login-error" class="form-error" role="alert" aria-live="assertive"></div>
            <button type="submit" class="btn btn-primary btn-full" id="login-btn">Sign in</button>
          </div>
        </form>

        <div class="divider"><span>or</span></div>

        <button class="btn btn-google btn-full" id="google-login-btn" type="button">
          <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
            <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
            <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z" fill="#FBBC05"/>
            <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
          </svg>
          Continue with Google
        </button>
      </div>

      <!-- Register -->
      <div class="auth-form-panel" id="panel-register" role="tabpanel" aria-labelledby="tab-register">
        <form id="register-form" novalidate>
          <div class="auth-form-panel active" style="gap:var(--sp-md);">
            <div class="form-group">
              <label class="form-label" for="reg-name">Full name</label>
              <input class="form-input" type="text" id="reg-name" name="displayName"
                     autocomplete="name" placeholder="Your name" required />
            </div>
            <div class="form-group">
              <label class="form-label" for="reg-email">Email</label>
              <input class="form-input" type="email" id="reg-email" name="email"
                     autocomplete="email" placeholder="you@example.com" required />
            </div>
            <div class="form-group">
              <label class="form-label" for="reg-password">Password</label>
              <input class="form-input" type="password" id="reg-password" name="password"
                     autocomplete="new-password" placeholder="At least 6 characters" required minlength="6" />
            </div>
            <p class="form-hint" style="font-size:0.8125rem;color:var(--text-muted);">
              A unique @username will be generated automatically. You can change it in your profile.
            </p>
            <div id="register-error" class="form-error" role="alert" aria-live="assertive"></div>
            <button type="submit" class="btn btn-primary btn-full" id="register-btn">Create account</button>
          </div>
        </form>

        <div class="divider"><span>or</span></div>

        <button class="btn btn-google btn-full" id="google-register-btn" type="button">
          <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
            <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
            <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z" fill="#FBBC05"/>
            <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
          </svg>
          Continue with Google
        </button>
      </div>

      <p class="auth-footer">
        By continuing you agree to our <a href="#">Terms</a> and <a href="#">Privacy Policy</a>.
        &nbsp;·&nbsp; <a href="home.html">Back to home</a>
      </p>
    </div>
  </section>
</main>

<script type="module">
import { loadTheme } from './assets/js/theme.js';
import { redirectIfAuthed } from './assets/js/guard.js';
import { registerWithEmail, loginWithEmail, loginWithGoogle, handleGoogleRedirect, friendlyAuthError } from './assets/js/auth.js';
import { toast, setButtonLoading, showFormError, clearFormError } from './assets/js/ui.js';

loadTheme();
redirectIfAuthed();

handleGoogleRedirect().then(u => { if (u) window.location.replace('/app.html'); });

// Tab auto-open if URL has #register
if (location.hash === '#register') {
  document.getElementById('tab-register').click();
}

// ─── Tabs ─────────────────────────────────────────────────
const tabs   = document.querySelectorAll('.auth-tab');
const panels = document.querySelectorAll('.auth-form-panel[id^="panel"]');
const title  = document.getElementById('auth-title');
const sub    = document.getElementById('auth-sub');

tabs.forEach(tab => {
  tab.addEventListener('click', () => {
    tabs.forEach(t => { t.classList.remove('active'); t.setAttribute('aria-selected','false'); });
    panels.forEach(p => p.classList.remove('active'));
    tab.classList.add('active');
    tab.setAttribute('aria-selected','true');
    document.getElementById('panel-' + tab.dataset.tab).classList.add('active');
    if (tab.dataset.tab === 'register') {
      title.textContent = 'Create your account';
      sub.textContent   = 'Get your unique @username instantly';
    } else {
      title.textContent = 'Welcome back';
      sub.textContent   = 'Sign in to continue your conversations';
    }
  });
});

// ─── Login ────────────────────────────────────────────────
document.getElementById('login-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  const btn = document.getElementById('login-btn');
  const err = document.getElementById('login-error');
  clearFormError(err);

  const email    = document.getElementById('login-email').value.trim();
  const password = document.getElementById('login-password').value;
  if (!email || !password) { showFormError(err, 'Please fill in all fields.'); return; }

  setButtonLoading(btn, true);
  try {
    await loginWithEmail(email, password);
    window.location.replace('/app.html');
  } catch (ex) {
    showFormError(err, friendlyAuthError(ex.code));
    setButtonLoading(btn, false);
  }
});

// ─── Register ─────────────────────────────────────────────
document.getElementById('register-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  const btn = document.getElementById('register-btn');
  const err = document.getElementById('register-error');
  clearFormError(err);

  const name     = document.getElementById('reg-name').value.trim();
  const email    = document.getElementById('reg-email').value.trim();
  const password = document.getElementById('reg-password').value;

  if (!name || !email || !password) { showFormError(err, 'Please fill in all fields.'); return; }
  if (password.length < 6) { showFormError(err, 'Password must be at least 6 characters.'); return; }

  setButtonLoading(btn, true);
  try {
    await registerWithEmail(email, password, name);
    window.location.replace('/app.html');
  } catch (ex) {
    showFormError(err, friendlyAuthError(ex.code));
    setButtonLoading(btn, false);
  }
});

// ─── Google ───────────────────────────────────────────────
async function handleGoogle(btn) {
  setButtonLoading(btn, true);
  try {
    const user = await loginWithGoogle();
    if (user) window.location.replace('/app.html');
  } catch (ex) {
    toast(friendlyAuthError(ex.code), 'error');
    setButtonLoading(btn, false);
  }
}

document.getElementById('google-login-btn').addEventListener('click', function() { handleGoogle(this); });
document.getElementById('google-register-btn').addEventListener('click', function() { handleGoogle(this); });
</script>
</body>
</html>
